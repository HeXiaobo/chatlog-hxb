<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼ è¯Šæ–­å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .log { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ“‹ æ–‡ä»¶ä¸Šä¼ è¯Šæ–­å·¥å…·</h1>
    <p>è¿™ä¸ªå·¥å…·å°†è‡ªåŠ¨æµ‹è¯•æ–‡ä»¶ä¸Šä¼ æµç¨‹çš„å„ä¸ªç¯èŠ‚ï¼Œå¸®åŠ©å®šä½é—®é¢˜ã€‚</p>
    
    <button onclick="runFullDiagnosis()">ğŸ” å¼€å§‹å®Œæ•´è¯Šæ–­</button>
    <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    
    <div id="results"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://atgkpaszasqhycvvszll.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0Z2twYXN6YXNxaHljdnZzemt\n\n\nsuperset-chart\nlseyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoyMDQxNDQ5ODM0LCJpYXQiOjE3MjU4ODk4MzQsImlzcyI6InN1cGFiYXNlIiwianRpIjoiYjBhMGVmMzAtYjMzNS00MzQ4LWJlZTUtYWI4YWRhZmM0ODc4Iiwicm9sZSI6ImFub24iLCJzdWIiOiJiMGEwZWYzMC1iMzM1LTQzNDgtYmVlNS1hYjhhZGFmYzQ4NzgiLCJ1c2VyX21ldGFkYXRhIjp7fX0.xNa9eJOaT_dqvFr5C7KZ2-cWpbhNZkfIq3o-3MZjOhY'
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        // æµ‹è¯•æ•°æ®
        const testData = [
            {
                "id": "msg_001",
                "timestamp": 1704067200000,
                "from_user": "å®¢æˆ·å¼ ä¸‰",
                "content": "è¯·é—®ä½ ä»¬çš„äº§å“æœ‰ä»€ä¹ˆåŠŸèƒ½ï¼Ÿ",
                "message_type": "text"
            },
            {
                "id": "msg_002", 
                "timestamp": 1704067260000,
                "from_user": "å®¢æœå°æ",
                "content": "æˆ‘ä»¬çš„äº§å“ä¸»è¦æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š1. æ•°æ®åˆ†æ 2. æŠ¥è¡¨ç”Ÿæˆ 3. ç”¨æˆ·ç®¡ç†ã€‚",
                "message_type": "text"
            }
        ]
        
        function log(message, type = 'info') {
            const results = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `test ${type}`
            div.innerHTML = `
                <strong>[${new Date().toLocaleTimeString()}]</strong> ${message}
            `
            results.appendChild(div)
            results.scrollTop = results.scrollHeight
        }
        
        function clearLogs() {
            document.getElementById('results').innerHTML = ''
        }
        
        async function testSupabaseConnection() {
            log('ğŸ”— æµ‹è¯• Supabase è¿æ¥...', 'info')
            try {
                const { data, error } = await supabase.from('categories').select('*').limit(1)
                if (error) throw error
                log('âœ… Supabase è¿æ¥æˆåŠŸ', 'success')
                return true
            } catch (error) {
                log(`âŒ Supabase è¿æ¥å¤±è´¥: ${error.message}`, 'error')
                return false
            }
        }
        
        async function testStorageUpload() {
            log('ğŸ“ æµ‹è¯• Storage æ–‡ä»¶ä¸Šä¼ ...', 'info')
            try {
                const fileName = `test-${Date.now()}.json`
                const fileContent = JSON.stringify(testData, null, 2)
                const file = new File([fileContent], fileName, { type: 'application/json' })
                
                const { data, error } = await supabase.storage
                    .from('wechat-files')
                    .upload(fileName, file)
                
                if (error) throw error
                log(`âœ… Storage ä¸Šä¼ æˆåŠŸ: ${fileName}`, 'success')
                return { success: true, fileName }
            } catch (error) {
                log(`âŒ Storage ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error')
                return { success: false, error: error.message }
            }
        }
        
        async function testEdgeFunction() {
            log('âš¡ æµ‹è¯• Edge Function è°ƒç”¨...', 'info')
            try {
                const { data, error } = await supabase.functions.invoke('process-wechat-file', {
                    body: {
                        fileName: 'test-diagnosis.json',
                        fileContent: testData
                    }
                })
                
                if (error) throw error
                
                log(`âœ… Edge Function è°ƒç”¨æˆåŠŸ`, 'success')
                log(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success')
                return { success: true, data }
            } catch (error) {
                log(`âŒ Edge Function è°ƒç”¨å¤±è´¥: ${error.message}`, 'error')
                log(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error')
                return { success: false, error: error.message }
            }
        }
        
        async function testDatabaseInsert() {
            log('ğŸ—„ï¸ æµ‹è¯•ç›´æ¥æ•°æ®åº“æ’å…¥...', 'info')
            try {
                // æµ‹è¯•æ’å…¥ä¸Šä¼ è®°å½•
                const { data, error } = await supabase
                    .from('upload_history')
                    .insert({
                        filename: 'test-diagnosis.json',
                        original_name: 'test-diagnosis.json',
                        file_size: 1000,
                        status: 'completed',
                        total_count: 2,
                        processed_count: 2
                    })
                    .select()
                
                if (error) throw error
                log('âœ… æ•°æ®åº“æ’å…¥æˆåŠŸ', 'success')
                return { success: true, data }
            } catch (error) {
                log(`âŒ æ•°æ®åº“æ’å…¥å¤±è´¥: ${error.message}`, 'error')
                return { success: false, error: error.message }
            }
        }
        
        async function runFullDiagnosis() {
            log('ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­...', 'info')
            
            // 1. æµ‹è¯• Supabase è¿æ¥
            const connectionTest = await testSupabaseConnection()
            if (!connectionTest) {
                log('ğŸ›‘ Supabase è¿æ¥å¤±è´¥ï¼Œåœæ­¢è¯Šæ–­', 'error')
                return
            }
            
            // 2. æµ‹è¯• Storage ä¸Šä¼ 
            const storageTest = await testStorageUpload()
            
            // 3. æµ‹è¯•æ•°æ®åº“æ’å…¥
            const dbTest = await testDatabaseInsert()
            
            // 4. æµ‹è¯• Edge Function
            const edgeFunctionTest = await testEdgeFunction()
            
            // 5. ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
            log('ğŸ“Š è¯Šæ–­æŠ¥å‘Šç”Ÿæˆä¸­...', 'info')
            
            const report = {
                supabase_connection: connectionTest,
                storage_upload: storageTest.success,
                database_insert: dbTest.success,
                edge_function: edgeFunctionTest.success,
                errors: {
                    storage: storageTest.error || null,
                    database: dbTest.error || null,
                    edge_function: edgeFunctionTest.error || null
                }
            }
            
            log('<h3>ğŸ¯ è¯Šæ–­æ€»ç»“</h3>', 'info')
            log(`<pre>${JSON.stringify(report, null, 2)}</pre>`, 'info')
            
            // 6. å»ºè®®ä¿®å¤æ–¹æ¡ˆ
            if (!storageTest.success) {
                log('ğŸ’¡ å»ºè®®ï¼šStorage ä¸Šä¼ å¤±è´¥ï¼Œæ£€æŸ¥ Storage RLS ç­–ç•¥', 'info')
            }
            if (!dbTest.success) {
                log('ğŸ’¡ å»ºè®®ï¼šæ•°æ®åº“æ’å…¥å¤±è´¥ï¼Œæ£€æŸ¥è¡¨ RLS ç­–ç•¥', 'info')
            }
            if (!edgeFunctionTest.success) {
                log('ğŸ’¡ å»ºè®®ï¼šEdge Function å¤±è´¥ï¼Œæ£€æŸ¥å‡½æ•°ä»£ç å’Œæƒé™', 'info')
            }
            
            log('âœ¨ è¯Šæ–­å®Œæˆï¼', 'success')
        }
    </script>
</body>
</html>