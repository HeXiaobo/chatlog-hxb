<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨è¯Šæ–­å·¥å…·</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test { margin: 15px 0; padding: 15px; border-radius: 8px; border-left: 4px solid #ddd; }
        .success { background: #d4edda; border-left-color: #28a745; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .info { background: #d1ecf1; border-left-color: #17a2b8; }
        .warning { background: #fff3cd; border-left-color: #ffc107; }
        button { 
            padding: 12px 24px; margin: 8px; 
            background: #007bff; color: white; 
            border: none; border-radius: 6px; 
            cursor: pointer; font-size: 14px; 
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 12px; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress { width: 100%; background-color: #e9ecef; border-radius: 4px; margin: 10px 0; }
        .progress-bar { height: 20px; background-color: #007bff; border-radius: 4px; transition: width 0.3s ease; }
        h1 { color: #333; border-bottom: 3px solid #007bff; padding-bottom: 10px; }
        h3 { color: #495057; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ChatLog æ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨è¯Šæ–­å·¥å…·</h1>
        <p>è¿™ä¸ªå·¥å…·å°†è‡ªåŠ¨æµ‹è¯•æ–‡ä»¶ä¸Šä¼ æµç¨‹çš„æ‰€æœ‰ç¯èŠ‚ï¼Œç²¾ç¡®å®šä½é—®é¢˜æ‰€åœ¨ã€‚</p>
        
        <div>
            <button id="startBtn" onclick="runFullDiagnosis()">ğŸš€ å¼€å§‹è‡ªåŠ¨è¯Šæ–­</button>
            <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
            <button onclick="testSingleStep()">ğŸ” å•æ­¥æµ‹è¯•</button>
        </div>
        
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        
        <div id="results"></div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.js"></script>
    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://atgkpaszasqhycvvszll.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0Z2twYXN6YXNxaHljdnZzemxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTA2OTQsImV4cCI6MjA3MDA2NjY5NH0.BSh5066lya593cXhVDCvGu0l30X1pVq33FY3z1P7410'
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        // æµ‹è¯•æ•°æ®
        const testData = [
            {
                "id": "msg_001",
                "timestamp": 1704067200000,
                "from_user": "å®¢æˆ·å¼ ä¸‰",
                "content": "è¯·é—®ä½ ä»¬çš„äº§å“æœ‰ä»€ä¹ˆåŠŸèƒ½ï¼Ÿ",
                "message_type": "text"
            },
            {
                "id": "msg_002", 
                "timestamp": 1704067260000,
                "from_user": "å®¢æœå°æ",
                "content": "æˆ‘ä»¬çš„äº§å“ä¸»è¦æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š1. æ•°æ®åˆ†æ 2. æŠ¥è¡¨ç”Ÿæˆ 3. ç”¨æˆ·ç®¡ç†ã€‚å¯ä»¥å¸®åŠ©ä¼ä¸šæé«˜å·¥ä½œæ•ˆç‡ã€‚",
                "message_type": "text"
            }
        ]
        
        let currentStep = 0
        const totalSteps = 6
        
        function updateProgress(step) {
            currentStep = step
            const percentage = (step / totalSteps) * 100
            document.getElementById('progressBar').style.width = percentage + '%'
        }
        
        function log(message, type = 'info', showSpinner = false) {
            const results = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `test ${type}`
            const timestamp = new Date().toLocaleTimeString()
            const spinner = showSpinner ? '<span class="spinner"></span> ' : ''
            div.innerHTML = `<strong>[${timestamp}]</strong> ${spinner}${message}`
            results.appendChild(div)
            results.scrollTop = results.scrollHeight
            return div
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = ''
            document.getElementById('progressContainer').style.display = 'none'
            currentStep = 0
        }
        
        async function testSupabaseConnection() {
            const logDiv = log('ğŸ”— æ­£åœ¨æµ‹è¯• Supabase åŸºç¡€è¿æ¥...', 'info', true)
            try {
                const { data, error } = await supabaseClient.from('categories').select('id, name').limit(1)
                if (error) throw error
                
                logDiv.innerHTML = logDiv.innerHTML.replace(/spinner.*?<\/span>\s*/, '')
                logDiv.className = 'test success'
                logDiv.innerHTML += `<br>âœ… Supabase è¿æ¥æˆåŠŸï¼Œæ‰¾åˆ° ${data.length} ä¸ªåˆ†ç±»`
                return { success: true, data }
            } catch (error) {
                logDiv.className = 'test error'
                logDiv.innerHTML = logDiv.innerHTML.replace(/spinner.*?<\/span>\s*/, '')
                logDiv.innerHTML += `<br>âŒ Supabase è¿æ¥å¤±è´¥: ${error.message}`
                return { success: false, error: error.message }
            }
        }
        
        async function testStorageBucket() {
            const logDiv = log('ğŸ“ æ­£åœ¨æµ‹è¯• Storage å­˜å‚¨æ¡¶è®¿é—®æƒé™...', 'info', true)
            try {
                const { data, error } = await supabaseClient.storage.from('wechat-files').list('', { limit: 1 })
                if (error) throw error
                
                logDiv.className = 'test success'
                logDiv.innerHTML = logDiv.innerHTML.replace(/spinner.*?<\/span>\s*/, '')
                logDiv.innerHTML += `<br>âœ… Storage å­˜å‚¨æ¡¶è®¿é—®æ­£å¸¸`
                return { success: true }
            } catch (error) {
                logDiv.className = 'test error'
                logDiv.innerHTML = logDiv.innerHTML.replace(/spinner.*?<\/span>\s*/, '')
                logDiv.innerHTML += `<br>âŒ Storage å­˜å‚¨æ¡¶è®¿é—®å¤±è´¥: ${error.message}`
                return { success: false, error: error.message }
            }
        }
        
        async function testFileUpload() {
            const logDiv = log('â¬†ï¸ æ­£åœ¨æµ‹è¯•æ–‡ä»¶ä¸Šä¼ åˆ° Storage...', 'info', true)
            try {
                const fileName = `test-${Date.now()}.json`
                const fileContent = JSON.stringify(testData, null, 2)
                const file = new File([fileContent], fileName, { type: 'application/json' })
                
                const { data, error } = await supabaseClient.storage
                    .from('wechat-files')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    })
                
                if (error) throw error
                
                logDiv.className = 'test success'
                logDiv.innerHTML = logDiv.innerHTML.replace(/spinner.*?<\/span>\s*/, '')
                logDiv.innerHTML += `<br>âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${fileName}`
                
                // æ¸…ç†æµ‹è¯•æ–‡ä»¶
                setTimeout(async () => {
                    await supabaseClient.storage.from('wechat-files').remove([fileName])
                }, 5000)
                
                return { success: true, fileName, data }
            } catch (error) {
                logDiv.className = 'test error'
                logDiv.innerHTML = logDiv.innerHTML.replace(/spinner.*?<\/span>\s*/, '')
                logDiv.innerHTML += `<br>âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${error.message}`
                return { success: false, error: error.message }
            }
        }
        
        async function testDatabaseInsert() {
            const logDiv = log('ğŸ—„ï¸ æ­£åœ¨æµ‹è¯•æ•°æ®åº“æ’å…¥æ“ä½œ...', 'info', true)
            try {
                // å…ˆæµ‹è¯•æ’å…¥ä¸Šä¼ å†å²è®°å½•
                const uploadData = {
                    filename: `test-${Date.now()}.json`,
                    original_name: 'auto-test.json',
                    file_size: 1000,
                    status: 'processing',
                    total_count: 2,
                    processed_count: 0
                }
                
                const { data, error } = await supabaseClient
                    .from('upload_history')
                    .insert(uploadData)
                    .select()
                
                if (error) throw error
                
                logDiv.className = 'test success'
                logDiv.innerHTML = logDiv.innerHTML.replace(/spinner.*?<\/span>\s*/, '')
                logDiv.innerHTML += `<br>âœ… æ•°æ®åº“æ’å…¥æˆåŠŸï¼Œè®°å½• ID: ${data[0].id}`
                
                // æ¸…ç†æµ‹è¯•æ•°æ®
                setTimeout(async () => {
                    await supabaseClient.from('upload_history').delete().eq('id', data[0].id)
                }, 5000)
                
                return { success: true, data: data[0] }
            } catch (error) {
                logDiv.className = 'test error'
                logDiv.innerHTML = logDiv.innerHTML.replace(/spinner.*?<\/span>\s*/, '')
                logDiv.innerHTML += `<br>âŒ æ•°æ®åº“æ’å…¥å¤±è´¥: ${error.message}`
                return { success: false, error: error.message }
            }
        }
        
        async function testEdgeFunction() {
            const logDiv = log('âš¡ æ­£åœ¨æµ‹è¯• Edge Function è°ƒç”¨...', 'info', true)
            try {
                const { data, error } = await supabaseClient.functions.invoke('process-wechat-file', {
                    body: {
                        fileName: 'auto-test.json',
                        fileContent: testData
                    }
                })
                
                if (error) throw error
                
                logDiv.className = 'test success'
                logDiv.innerHTML = logDiv.innerHTML.replace(/spinner.*?<\/span>\s*/, '')
                logDiv.innerHTML += `<br>âœ… Edge Function è°ƒç”¨æˆåŠŸ`
                logDiv.innerHTML += `<br><pre>${JSON.stringify(data, null, 2)}</pre>`
                
                return { success: true, data }
            } catch (error) {
                logDiv.className = 'test error'
                logDiv.innerHTML = logDiv.innerHTML.replace(/spinner.*?<\/span>\s*/, '')
                logDiv.innerHTML += `<br>âŒ Edge Function è°ƒç”¨å¤±è´¥: ${error.message}`
                logDiv.innerHTML += `<br><pre>${JSON.stringify(error, null, 2)}</pre>`
                return { success: false, error: error.message }
            }
        }
        
        async function testCompleteFlow() {
            const logDiv = log('ğŸ”„ æ­£åœ¨æµ‹è¯•å®Œæ•´ä¸Šä¼ æµç¨‹...', 'info', true)
            try {
                // 1. ä¸Šä¼ æ–‡ä»¶
                const fileName = `complete-test-${Date.now()}.json`
                const fileContent = JSON.stringify(testData, null, 2)
                const file = new File([fileContent], fileName, { type: 'application/json' })
                
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('wechat-files')
                    .upload(fileName, file)
                
                if (uploadError) throw new Error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${uploadError.message}`)
                
                // 2. è°ƒç”¨ Edge Function å¤„ç†
                const { data: processData, error: processError } = await supabaseClient.functions.invoke('process-wechat-file', {
                    body: {
                        fileName: fileName,
                        fileContent: testData
                    }
                })
                
                if (processError) throw new Error(`å¤„ç†å¤±è´¥: ${processError.message}`)
                
                logDiv.className = 'test success'
                logDiv.innerHTML = logDiv.innerHTML.replace(/spinner.*?<\/span>\s*/, '')
                logDiv.innerHTML += `<br>âœ… å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸï¼`
                logDiv.innerHTML += `<br>ğŸ“ æ–‡ä»¶: ${fileName}`
                logDiv.innerHTML += `<br>ğŸ“Š ç»“æœ: æå–äº† ${processData.data?.extracted_qa_pairs || 0} ä¸ªé—®ç­”å¯¹`
                
                // æ¸…ç†
                setTimeout(async () => {
                    await supabaseClient.storage.from('wechat-files').remove([fileName])
                }, 10000)
                
                return { success: true, data: processData }
            } catch (error) {
                logDiv.className = 'test error'
                logDiv.innerHTML = logDiv.innerHTML.replace(/spinner.*?<\/span>\s*/, '')
                logDiv.innerHTML += `<br>âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`
                return { success: false, error: error.message }
            }
        }
        
        async function runFullDiagnosis() {
            const startBtn = document.getElementById('startBtn')
            startBtn.disabled = true
            startBtn.textContent = 'è¯Šæ–­è¿›è¡Œä¸­...'
            
            document.getElementById('progressContainer').style.display = 'block'
            clearResults()
            
            log('ğŸš€ å¼€å§‹å®Œæ•´è‡ªåŠ¨è¯Šæ–­...', 'info')
            
            const results = {}
            
            // 1. æµ‹è¯•åŸºç¡€è¿æ¥
            updateProgress(1)
            results.connection = await testSupabaseConnection()
            if (!results.connection.success) {
                log('ğŸ›‘ åŸºç¡€è¿æ¥å¤±è´¥ï¼Œåœæ­¢è¯Šæ–­', 'error')
                startBtn.disabled = false
                startBtn.textContent = 'ğŸš€ å¼€å§‹è‡ªåŠ¨è¯Šæ–­'
                return
            }
            
            // 2. æµ‹è¯•å­˜å‚¨æ¡¶
            updateProgress(2)
            results.storage_bucket = await testStorageBucket()
            
            // 3. æµ‹è¯•æ–‡ä»¶ä¸Šä¼ 
            updateProgress(3)
            results.file_upload = await testFileUpload()
            
            // 4. æµ‹è¯•æ•°æ®åº“æ“ä½œ
            updateProgress(4)
            results.database = await testDatabaseInsert()
            
            // 5. æµ‹è¯• Edge Function
            updateProgress(5)
            results.edge_function = await testEdgeFunction()
            
            // 6. æµ‹è¯•å®Œæ•´æµç¨‹
            updateProgress(6)
            results.complete_flow = await testCompleteFlow()
            
            // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
            generateDiagnosticReport(results)
            
            startBtn.disabled = false
            startBtn.textContent = 'ğŸš€ å¼€å§‹è‡ªåŠ¨è¯Šæ–­'
            updateProgress(totalSteps)
        }
        
        function generateDiagnosticReport(results) {
            log('<h3>ğŸ“Š è¯Šæ–­æŠ¥å‘Š</h3>', 'info')
            
            const summary = {
                'åŸºç¡€è¿æ¥': results.connection.success,
                'å­˜å‚¨æ¡¶è®¿é—®': results.storage_bucket.success,
                'æ–‡ä»¶ä¸Šä¼ ': results.file_upload.success,
                'æ•°æ®åº“æ“ä½œ': results.database.success,
                'Edge Function': results.edge_function.success,
                'å®Œæ•´æµç¨‹': results.complete_flow.success
            }
            
            log(`<pre>${JSON.stringify(summary, null, 2)}</pre>`, 'info')
            
            // é—®é¢˜åˆ†æå’Œå»ºè®®
            if (!results.storage_bucket.success) {
                log('ğŸ’¡ å»ºè®®ï¼šStorage å­˜å‚¨æ¡¶æƒé™é—®é¢˜ï¼Œéœ€è¦æ£€æŸ¥ RLS ç­–ç•¥', 'warning')
                log('è§£å†³æ–¹æ¡ˆï¼šåœ¨ Supabase Dashboard ä¸­ç¦ç”¨ storage.objects çš„ RLS æˆ–è°ƒæ•´ç­–ç•¥', 'warning')
            }
            
            if (!results.file_upload.success) {
                log('ğŸ’¡ å»ºè®®ï¼šæ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œæ£€æŸ¥ Storage é…ç½®å’Œæƒé™', 'warning')
                log('è§£å†³æ–¹æ¡ˆï¼šéªŒè¯ Storage bucket æ˜¯å¦æ­£ç¡®åˆ›å»ºï¼ŒRLS ç­–ç•¥æ˜¯å¦å…è®¸ä¸Šä¼ ', 'warning')
            }
            
            if (!results.database.success) {
                log('ğŸ’¡ å»ºè®®ï¼šæ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œæ£€æŸ¥è¡¨çš„ RLS ç­–ç•¥', 'warning')
                log('è§£å†³æ–¹æ¡ˆï¼šä¸´æ—¶ç¦ç”¨ç›¸å…³è¡¨çš„ RLS æˆ–è°ƒæ•´ç­–ç•¥å…è®¸æ’å…¥', 'warning')
            }
            
            if (!results.edge_function.success) {
                log('ğŸ’¡ å»ºè®®ï¼šEdge Function è°ƒç”¨å¤±è´¥ï¼Œæ£€æŸ¥å‡½æ•°ä»£ç å’Œæƒé™', 'warning')
                log('è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥å‡½æ•°æ˜¯å¦æ­£ç¡®éƒ¨ç½²ï¼Œç¯å¢ƒå˜é‡æ˜¯å¦è®¾ç½®', 'warning')
            }
            
            if (results.complete_flow.success) {
                log('ğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸï¼æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æ­£å¸¸å·¥ä½œ', 'success')
            } else {
                log('âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦ä¿®å¤ä¸Šè¿°é—®é¢˜', 'error')
            }
            
            log('âœ¨ è‡ªåŠ¨è¯Šæ–­å®Œæˆï¼', 'info')
        }
        
        function testSingleStep() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ å•æ­¥æµ‹è¯•çš„åŠŸèƒ½
            log('ğŸ” å•æ­¥æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...', 'info')
        }
    </script>
</body>
</html>